<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calculadora SplitLoot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* Estilos isolados para a calculadora */
        #loot-calculator-isolated {
            --gold-accent: #d69e2e;
            --danger-color: #e53e3e;
            --success-color: #48bb78;
            --text-color: #e2e8f0;
            --text-muted-color: #a0aec0;
            --tag-blue: #4299e1;
            --tag-yellow: #ecc94b;
            --tag-green: #48bb78;
            --tag-red: #f56565;
            --tag-purple: #9f7aea;
            --tag-white: #e2e8f0;
            --tag-black: #2d3748;

            
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
            border-radius: 10px;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
        }
        
        /* Reset interno para evitar vazamentos */
        #loot-calculator-isolated * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        #loot-calculator-isolated .header-container {
            text-align: center;
            margin-bottom: 25px;
            padding: 15px;
            background: linear-gradient(135deg, #1a202c 0%, #0d1117 100%);
            border-radius: 10px;
            border: 1px solid var(--gold-accent);
        }
        
        #loot-calculator-isolated .header-container h1 {
            color: var(--gold-accent);
            font-size: 1.8rem;
            margin-bottom: 10px;
        }
        
        #loot-calculator-isolated .loot-container {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        
        @media (min-width: 768px) {
            #loot-calculator-isolated .loot-container {
                flex-direction: row;
            }
        }
        
        #loot-calculator-isolated .loot-panel {
            flex: 1;
            background-color: var(--panel-bg-color);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 20px;
        }
        
        #loot-calculator-isolated .loot-container h3, 
        #loot-calculator-isolated .loot-container h4 {
            color: var(--gold-accent);
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
            margin: 0 0 15px 0;
            font-weight: 600;
            font-size: 1.2rem;
        }
        
        #loot-calculator-isolated .loot-container textarea {
            width: 100%;
            min-height: 150px;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-family: monospace;
            background-color: var(--bg-color);
            color: var(--text-color);
            font-size: 0.9rem;
            resize: vertical;
        }
        
        #loot-calculator-isolated .button-container {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        #loot-calculator-isolated .loot-container button {
            background-color: var(--tag-blue);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }
        
        #loot-calculator-isolated .loot-container button:hover {
            filter: brightness(1.1);
            transform: translateY(-2px);
        }
        
        #loot-calculator-isolated .loot-container button i {
            font-size: 1rem;
        }
        
        #loot-calculator-isolated .loot-container button.clear {
            background-color: var(--danger-color);
        }
        
        #loot-calculator-isolated .loot-container button.recalculate {
            background-color: var(--success-color);
        }
        
        #loot-calculator-isolated .transfer {
            margin-top: 8px;
            padding: 10px;
            background-color: var(--bg-color);
            border-radius: 6px;
            border-left: 3px solid var(--success-color);
            cursor: pointer;
            font-family: monospace;
            transition: all 0.2s ease;
            font-size: 0.9rem;
            white-space: pre-line;
        }

        #loot-calculator-isolated .transfer.copied {
            background-color: rgba(35, 134, 54, 0.4);
            border-left: 3px solid #48bb78;
        }
        
        #loot-calculator-isolated .summary, 
        #loot-calculator-isolated .add-player-form, 
        #loot-calculator-isolated .history-section {
            margin-top: 15px;
            padding: 15px;
            background-color: var(--bg-color);
            border-radius: 8px;
        }
        
        #loot-calculator-isolated .players-table, 
        #loot-calculator-isolated .history-table {
            width: 100%;
            border-collapse: collapse;
            margin: 10px 0;
            font-size: 0.85rem;
        }
        
        #loot-calculator-isolated .players-table th, 
        #loot-calculator-isolated .players-table td, 
        #loot-calculator-isolated .history-table th, 
        #loot-calculator-isolated .history-table td {
            padding: 8px 10px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        
        #loot-calculator-isolated .players-table th {
            font-weight: 600;
        }
        
        #loot-calculator-isolated .profit-input, 
        #loot-calculator-isolated .waste-input {
            background: none;
            border: 1px solid;
            border-radius: 6px;
            padding: 6px;
            width: 90px;
            text-align: right;
            color: var(--text-color);
            font-family: monospace;
            font-size: 0.85rem;
        }
        
        #loot-calculator-isolated .profit-input {
            border-color: var(--success-color);
        }
        
        #loot-calculator-isolated .waste-input {
            border-color: var(--danger-color);
        }
        
        /* Estatísticas compactas */
        #loot-calculator-isolated .compact-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        #loot-calculator-isolated .stats-column {
            flex: 1;
            min-width: 150px;
        }
        
        #loot-calculator-isolated .stats-column h4 {
            font-size: 1rem;
            margin-bottom: 10px;
            border: none;
            color: var(--gold-accent);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #loot-calculator-isolated .stats-list {
            list-style: none;
            padding: 0;
        }
        
        #loot-calculator-isolated .stats-list li {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            padding: 6px 0;
            border-bottom: 1px dashed var(--border-color);
        }
        
        #loot-calculator-isolated .tag-selector {
            display: flex;
            gap: 8px;
            margin: 10px 0;
            flex-wrap: wrap;
        }
        
        #loot-calculator-isolated .tag {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        
        #loot-calculator-isolated .tag:hover {
            transform: scale(1.1);
        }
        
        #loot-calculator-isolated .tag.active {
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--bg-color);
        }
        
        #loot-calculator-isolated .tag.blue { background-color: var(--tag-blue); }
        #loot-calculator-isolated .tag.yellow { background-color: var(--tag-yellow); }
        #loot-calculator-isolated .tag.green { background-color: var(--tag-green); }
        #loot-calculator-isolated .tag.red { background-color: var(--tag-red); }
        #loot-calculator-isolated .tag.purple { background-color: var(--tag-purple); }
        #loot-calculator-isolated .tag.white { background-color: var(--tag-white); }
        #loot-calculator-isolated .tag.black { background-color: var(--tag-black); }
        
        #loot-calculator-isolated .history-tag {
            display: inline-block;
            width: 14px;
            height: 14px;
            border-radius: 3px;
            margin-right: 6px;
            vertical-align: middle;
        }
        
        #loot-calculator-isolated .no-results {
            text-align: center;
            padding: 30px 15px;
            color: var(--text-muted-color);
            font-size: 1rem;
        }
        
        #loot-calculator-isolated .no-results i {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--border-color);
        }
        
        #loot-calculator-isolated .section-title {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        #loot-calculator-isolated .section-title i {
            color: var(--gold-accent);
            font-size: 1rem;
        }
        
        #loot-calculator-isolated .unsaved-changes {
            color: var(--danger-color);
            font-size: 0.75rem;
            margin-top: 8px;
            display: none;
            padding: 5px;
            border-radius: 4px;
        }
        
        /* Layout compacto para histórico */
        #loot-calculator-isolated .history-table th,
        #loot-calculator-isolated .history-table td {
            padding: 6px 10px;
            font-size: 0.8rem;
        }
        
        #loot-calculator-isolated .history-table .actions {
            display: flex;
            gap: 5px;
        }
        
        #loot-calculator-isolated .icon-btn {
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        #loot-calculator-isolated .icon-btn:hover {
            background: rgba(66, 153, 225, 0.3);
        }
        
        #loot-calculator-isolated .icon-btn.delete {
            background: rgba(229, 62, 62, 0.2);
        }
        
        #loot-calculator-isolated .icon-btn.delete:hover {
            background: rgba(229, 62, 62, 0.3);
        }
        
        /* Resumo compacto */
        #loot-calculator-isolated .session-summary {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }
        
        #loot-calculator-isolated .summary-item {
            background: rgba(66, 153, 225, 0.1);
            padding: 8px 12px;
            border-radius: 6px;
            flex: 1;
            min-width: 150px;
        }
        
        #loot-calculator-isolated .summary-item .label {
            font-size: 0.8rem;
            color: var(--text-muted-color);
            margin-bottom: 3px;
        }
        
        #loot-calculator-isolated .summary-item .value {
            font-weight: bold;
            color: var(--gold-accent);
        }
        
        /* Estatísticas de dano/cura lado a lado */
        #loot-calculator-isolated .damage-healing-container {
            display: flex;
            gap: 20px;
            margin-top: 15px;
        }
        
        #loot-calculator-isolated .damage-healing-column {
            flex: 1;
        }
        
        /* Estatísticas de profit */
        #loot-calculator-isolated .profit-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 15px;
        }
        
        #loot-calculator-isolated .profit-stat {
            background: rgba(214, 158, 46, 0.1);
            padding: 10px 15px;
            border-radius: 8px;
            flex: 1;
            min-width: 180px;
        }
        
        #loot-calculator-isolated .profit-stat .label {
            font-size: 0.85rem;
            color: var(--text-muted-color);
            margin-bottom: 5px;
        }
        
        #loot-calculator-isolated .profit-stat .value {
            font-weight: bold;
            color: var(--success-color);
            font-size: 1.1rem;
        }
    </style>
</head>
<body>
    <!-- Container isolador para evitar conflitos de CSS -->
    <div id="loot-calculator-isolated">
        <div class="header-container">
            <h1><i class="fas fa-coins"></i> Calculadora de Loot</h1>
            <p>Clique na transfer para copiar</p>
        </div>

        <div class="loot-container">
            <div class="loot-panel">
                <div class="section-title">
                    <h3>Cole o Clipboard Party</h3>
                    <div class="tag-selector" style="margin-left: auto;">
                        <div class="tag blue active" data-tag="blue" title="Azul"></div>
                        <div class="tag yellow" data-tag="yellow" title="Amarelo"></div>
                        <div class="tag green" data-tag="green" title="Verde"></div>
                        <div class="tag red" data-tag="red" title="Vermelho"></div>
                        <div class="tag purple" data-tag="purple" title="Roxo"></div>
                    </div>
                </div>
                <textarea id="sessionData" placeholder="Cole o clipboard da party do Tibia aqui..."></textarea> 
                
                <div class="button-container">
                    <button id="loot-calculate-btn">
                        <i class="fas fa-calculator"></i> Calcular
                    </button>
                    <button id="loot-recalculate-btn" class="recalculate" style="display: none;">
                        <i class="fas fa-sync-alt"></i> Recalcular
                    </button>
                    <button id="loot-clear-btn" class="clear">
                        <i class="fas fa-trash"></i> Limpar
                    </button>
                </div>
                
                <div id="playersTableContainer" style="display: none;">
                    <table class="players-table">
                        <thead>
                            <tr>
                                <th>Player</th>
                                <th>Balance</th>
                                <th>Profit (+)</th>
                                <th>Waste (-)</th>
                                <th>Ativo</th>
                            </tr>
                        </thead>
                        <tbody id="playersTableBody"></tbody>
                    </table>
                    
                    <div class="add-player-form">
                        <div class="section-title">
                            <i class="fas fa-user-plus"></i>
                            <h3>Adicionar Player</h3>
                        </div>
                        <div style="display: flex; gap: 10px; margin-bottom: 12px;">
                            <input type="text" id="newPlayerName" placeholder="Nome" style="flex: 1; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 0.9rem;">
                            <input type="text" id="newPlayerBalance" placeholder="Balance" style="width: 120px; padding: 8px; border-radius: 6px; border: 1px solid var(--border-color); background: var(--bg-color); color: var(--text-color); font-size: 0.9rem;">
                        </div>
                        <button id="loot-add-player-btn" style="width: 100%; padding: 8px;">
                            <i class="fas fa-plus"></i> Adicionar Player
                        </button>
                    </div>
                </div>
                
                <div class="history-section">
                    <div class="section-title">
                        <i class="fas fa-history"></i>
                        <h4>Histórico de Cálculos</h4>
                    </div>
                    <div id="historyTableContainer" style="max-height: 200px; overflow-y: auto;">
                        <table class="history-table">
                            <thead>
                                <tr>
                                    <th>Tag</th>
                                    <th>Data</th>
                                    <th>Balanço</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="historyTableBody"></tbody>
                        </table>
                    </div>
                    <button id="clear-history-btn" class="clear" style="width: 100%; margin-top: 12px; padding: 8px;">
                        <i class="fas fa-broom"></i> Limpar Histórico
                    </button>
                </div>
            </div>
            
            <div class="loot-panel">
                <div id="result" style="display: none;">
                    <div class="session-summary">
                        <div class="summary-item">
                            <div class="label">Players ativos</div>
                            <div class="value" id="activePlayersCount">0</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Duração</div>
                            <div class="value" id="sessionDuration">00:00h</div>
                        </div>
                        <div class="summary-item">
                            <div class="label">Data/Hora</div>
                            <div class="value" id="sessionDateTime">-</div>
                        </div>
                    </div>
                    
                    <div class="profit-stats">
                        <div class="profit-stat">
                            <div class="label"><i class="fas fa-coins"></i> Total Profit</div>
                            <div class="value" id="totalProfit">0 gp</div>
                        </div>
                        <div class="profit-stat">
                            <div class="label"><i class="fas fa-user"></i> Profit por Pessoa</div>
                            <div class="value" id="profitPerPlayer">0 gp</div>
                        </div>
                        <div class="profit-stat">
                            <div class="label"><i class="fas fa-clock"></i> Profit por Hora</div>
                            <div class="value" id="profitPerHour">0 gp</div>
                        </div>
                    </div>
                    
                    <div class="damage-healing-container">
                        <div class="damage-healing-column">
                            <h4><i class="fas fa-fist-raised"></i> Dano</h4>
                            <ul class="stats-list" id="damageList"></ul>
                        </div>
                        <div class="damage-healing-column">
                            <h4><i class="fas fa-heart"></i> Cura</h4>
                            <ul class="stats-list" id="healingList"></ul>
                        </div>
                    </div>
                    
                    <div id="transfers" style="margin-top: 15px;"></div>
                    <button id="copy-all-btn" style="margin-top: 15px; width: 100%; padding: 10px;">
                        <i class="fas fa-copy"></i> Copiar Tudo
                    </button>
                </div>
                <div id="empty-result" class="no-results">
                    <i class="fas fa-coins"></i>
                    <h3>Os resultados aparecerão aqui</h3>
                    <p>Insira os dados da party e clique em "Calcular"</p>
                </div>
            </div>
        </div>
        
        <div id="unsaved-changes" class="unsaved-changes">
            <i class="fas fa-exclamation-triangle"></i> Existem alterações não salvas - clique em "Recalcular" para atualizar
        </div>
    </div>

    <script>
        (function() {
            if (!document.getElementById('loot-calculate-btn')) return;

            let players = [];
            let sessionInfo = {};
            let currentCalcId = null;
            let lastCalculationResult = {};
            let currentTag = 'blue';
            let hasUnsavedChanges = false;

            function formatNumber(num) { 
                return (num || 0).toString().replace(/\B(?=(\d{3})+(?!\d))/g, "."); 
            }
            
            function cleanNumber(str) { 
                return parseInt(String(str).replace(/[.,]/g, '')) || 0; 
            }
            
            function parseTimeToHours(timeStr) {
                if (!timeStr) return 0;
                
                const match = timeStr.match(/(\d+):(\d+)/);
                if (match) {
                    const hours = parseInt(match[1]);
                    const minutes = parseInt(match[2]);
                    return hours + (minutes / 60);
                }
                return 0;
            }

            function parseData() {
                const data = document.getElementById('sessionData').value;
                players = [];
                sessionInfo = {};
                let currentPlayer = null;

                for (const line of data.split('\n')) {
                    const trimmedLine = line.trim();
                    if (trimmedLine === '') continue;

                    const sessionMatch = line.match(/Session:\s*([\d:]+h)/);
                    if(sessionMatch) sessionInfo.duration = sessionMatch[1];
                    
                    const lootMatch = line.match(/^Loot:\s*([\d,]+)/);
                    if(lootMatch) sessionInfo.totalLoot = cleanNumber(lootMatch[1]);
                    
                    const suppliesMatch = line.match(/Supplies:\s*([\d,]+)/);
                    if(suppliesMatch) sessionInfo.totalSupplies = cleanNumber(suppliesMatch[1]);
                    
                    const balanceMatch = line.match(/Balance:\s*([\d,]+)/);
                    if(balanceMatch && !currentPlayer) sessionInfo.totalBalance = cleanNumber(balanceMatch[1]);
                    
                    if (!line.startsWith('\t') && !line.startsWith('    ') && !trimmedLine.match(/^(Session|Loot Type|Loot|Supplies|Balance)/)) {
                        currentPlayer = {
                            name: trimmedLine.replace(' (Leader)', ''),
                            balance: 0, profit: 0, waste: 0, active: true, damage: 0, healing: 0
                        };
                        players.push(currentPlayer);
                    } else if (currentPlayer) {
                        const balanceMatch = line.match(/Balance:\s*([\d,.+-]+)/);
                        if (balanceMatch) currentPlayer.balance = cleanNumber(balanceMatch[1]);

                        const damageMatch = line.match(/Damage:\s*([\d,.]+)/);
                        if (damageMatch) currentPlayer.damage = cleanNumber(damageMatch[1]);
                        
                        const healingMatch = line.match(/Healing:\s*([\d,.]+)/);
                        if (healingMatch) currentPlayer.healing = cleanNumber(healingMatch[1]);
                    }
                }

                if (players.length > 0) {
                    displayPlayersTable();
                }
            }

            function displayPlayersTable() {
                const tableBody = document.getElementById('playersTableBody');
                tableBody.innerHTML = '';
                players.forEach((player, index) => {
                    const row = tableBody.insertRow();
                    row.dataset.index = index;
                    row.innerHTML = `
                        <td>${player.name} ↘</td>
                        <td>${formatNumber(player.balance)}</td>
                        <td><input type="text" class="profit-input" value="${formatNumber(player.profit)}"></td>
                        <td><input type="text" class="waste-input" value="${formatNumber(player.waste)}"></td>
                        <td style="text-align: center;"><input type="checkbox" class="player-active-checkbox" ${player.active ? 'checked' : ''}></td>
                    `;
                });
                document.getElementById('playersTableContainer').style.display = 'block';
            }

            function addManualPlayer() {
                const nameInput = document.getElementById('newPlayerName');
                const balanceInput = document.getElementById('newPlayerBalance');
                const name = nameInput.value.trim();
                const balance = cleanNumber(balanceInput.value);

                if (name && !isNaN(balance)) {
                    players.push({ name, balance, active: true, profit: 0, waste: 0, damage: 0, healing: 0 });
                    displayPlayersTable();
                    hasUnsavedChanges = true;
                    updateRecalculateButton();
                    nameInput.value = '';
                    balanceInput.value = '';
                }
            }

            function calculate() {
                const activePlayers = players.filter(p => p.active);
                const resultDiv = document.getElementById('result');
                const emptyResultDiv = document.getElementById('empty-result');
                if (activePlayers.length < 1) {
                    resultDiv.style.display = 'none';
                    emptyResultDiv.style.display = 'block';
                    return;
                }
                
                // Calcular o saldo líquido de cada jogador (balance + profit - waste)
                const totalBalance = activePlayers.reduce((sum, p) => sum + p.balance + p.profit - p.waste, 0);
                const share = Math.floor(totalBalance / activePlayers.length);
                
                // Calcular o quanto cada jogador deve receber ou pagar
                const playersWithBalance = activePlayers.map(p => {
                    const netBalance = p.balance + p.profit - p.waste;
                    const diff = netBalance - share;
                    return {
                        ...p,
                        netBalance,
                        diff
                    };
                });
                
                // ALGORITMO CORRIGIDO
                let transfers = [];
                
                // Identificar credores (quem tem a receber) e devedores (quem tem a pagar)
                let creditors = playersWithBalance
                    .filter(p => p.diff > 0)
                    .map(p => ({
                        name: p.name,
                        amount: p.diff
                    }));
                
                let debtors = playersWithBalance
                    .filter(p => p.diff < 0)
                    .map(p => ({
                        name: p.name,
                        amount: -p.diff // converter para positivo
                    }));
                
                // Ordenar: devedores do menor para o maior (menor dívida primeiro), 
                // credores do maior para o menor (maior crédito primeiro)
                debtors.sort((a, b) => a.amount - b.amount);
                creditors.sort((a, b) => b.amount - a.amount);
                
                // Calcular as transferências
                const debtorsCopy = JSON.parse(JSON.stringify(debtors));
                const creditorsCopy = JSON.parse(JSON.stringify(creditors));
                
                // Processar cada devedor
                for (let i = 0; i < debtorsCopy.length; i++) {
                    const debtor = debtorsCopy[i];
                    
                    // Processar cada credor para este devedor
                    for (let j = 0; j < creditorsCopy.length; j++) {
                        const creditor = creditorsCopy[j];
                        
                        if (debtor.amount > 0 && creditor.amount > 0) {
                            const amount = Math.min(debtor.amount, creditor.amount);
                            
                            transfers.push({
                                from: creditor.name,
                                to: debtor.name, 
                                amount: amount
                            });
                            
                            // Atualizar valores
                            debtor.amount -= amount;
                            creditor.amount -= amount;
                        }
                    }
                }
                
                currentCalcId = Date.now();
                lastCalculationResult = { transfers, totalBalance, share, activePlayers };
                displayResults(transfers, totalBalance, share, activePlayers);
                saveToHistory(transfers, totalBalance, share, activePlayers);
                hasUnsavedChanges = false;
                updateRecalculateButton();
            }
            
            function displayResults(transfers, totalBalance, share, activePlayers) {
                const transfersContainer = document.getElementById('transfers');
                const damageList = document.getElementById('damageList');
                const healingList = document.getElementById('healingList');
                
                // Limpar transferências anteriores
                transfersContainer.innerHTML = '';
                
                const totalDamage = activePlayers.reduce((sum, p) => sum + p.damage, 0);
                const totalHealing = activePlayers.reduce((sum, p) => sum + p.healing, 0);
                
                // Calcular horas da sessão
                const hours = parseTimeToHours(sessionInfo.duration);
                const profitPerHour = hours > 0 ? Math.floor(totalBalance / hours) : 0;
                
                // Atualizar resumo compacto
                document.getElementById('activePlayersCount').textContent = activePlayers.length;
                document.getElementById('sessionDuration').textContent = sessionInfo.duration || '00:00h';
                
                const now = new Date();
                document.getElementById('sessionDateTime').textContent = 
                    now.toLocaleDateString('pt-BR') + ' ' + now.toLocaleTimeString('pt-BR').substring(0, 5);
                
                // Atualizar estatísticas de profit
                document.getElementById('totalProfit').textContent = formatNumber(totalBalance) + ' gp';
                document.getElementById('profitPerPlayer').textContent = formatNumber(share) + ' gp';
                document.getElementById('profitPerHour').textContent = formatNumber(profitPerHour) + ' gp';

                // Limpar listas de dano e cura
                damageList.innerHTML = '';
                healingList.innerHTML = '';
                
                // Preencher estatísticas de dano
                activePlayers
                    .map(p => ({ 
                        name: p.name, 
                        perc: totalDamage > 0 ? (p.damage / totalDamage * 100) : 0 
                    }))
                    .sort((a,b) => b.perc - a.perc)
                    .forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${item.name}</span> <span>${item.perc.toFixed(2)}%</span>`;
                        damageList.appendChild(li);
                    });
                
                // Preencher estatísticas de cura
                activePlayers
                    .map(p => ({ 
                        name: p.name, 
                        perc: totalHealing > 0 ? (p.healing / totalHealing * 100) : 0 
                    }))
                    .sort((a,b) => b.perc - a.perc)
                    .forEach(item => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${item.name}</span> <span>${item.perc.toFixed(2)}%</span>`;
                        healingList.appendChild(li);
                    });

                // Exibir transferências no formato solicitado
// Exibir transferências com nome como título e texto formatado dentro da div
transfers.forEach(t => {
    // Criar container para cada transferência
    const transferContainer = document.createElement('div');
    transferContainer.style.marginBottom = '15px'; // Espaço entre transferências
    
    // Adicionar o nome como título (fora da div)
    const nameTitle = document.createElement('h4');
    nameTitle.textContent = t.from;
    nameTitle.style.marginBottom = '5px';
    nameTitle.style.color = 'var(--gold-accent)';
    transferContainer.appendChild(nameTitle);
    
    // Criar a div de transferência com o texto formatado
    const transferDiv = document.createElement('div');
    transferDiv.className = 'transfer';
    
    // Remover pontos do valor
    const amountWithoutDots = t.amount.toString().replace(/[.,]/g, '');
    const transferText = `transfer ${amountWithoutDots} to ${t.to}`;
    
    transferDiv.textContent = transferText;
    transferDiv.dataset.copytext = `transfer ${amountWithoutDots} to ${t.to}`;
    
    transferContainer.appendChild(transferDiv);
    transfersContainer.appendChild(transferContainer);
});
                
                document.getElementById('result').style.display = 'block';
                document.getElementById('empty-result').style.display = 'none';
            }

            function saveToHistory(transfers, totalBalance, share, activePlayers) {
                const historyData = {
                    id: currentCalcId,
                    tag: currentTag,
                    date: new Date().toLocaleString('pt-BR'),
                    sessionData: document.getElementById('sessionData').value,
                    players: JSON.parse(JSON.stringify(players)),
                    transfers,
                    totalBalance,
                    share,
                    activePlayers
                };
                let history = JSON.parse(localStorage.getItem('lootHistory') || '[]');
                history.unshift(historyData);
                if (history.length > 50) history.pop();
                localStorage.setItem('lootHistory', JSON.stringify(history));
                loadHistory();
            }
            
            function loadHistory() {
                const tableBody = document.getElementById('historyTableBody');
                tableBody.innerHTML = '';
                const history = JSON.parse(localStorage.getItem('lootHistory') || '[]');
                if (history.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 15px;">Nenhum cálculo salvo.</td></tr>';
                    return;
                }
                history.forEach(entry => {
                    const row = tableBody.insertRow();
                    if (entry.id === currentCalcId) row.style.backgroundColor = 'rgba(66, 153, 225, 0.1)';
                    
                    // Tag
                    const tagCell = row.insertCell();
                    tagCell.innerHTML = `<div class="history-tag" style="background-color: var(--tag-${entry.tag || 'blue'})"></div>`;
                    
                    // Data
                    const dateCell = row.insertCell();
                    dateCell.textContent = entry.date;
                    
                    // Balanço
                    const balanceCell = row.insertCell();
                    balanceCell.textContent = `${formatNumber(entry.totalBalance)} gp`;
                    
                    // Ações (compactadas)
                    const actionsCell = row.insertCell();
                    actionsCell.className = 'actions';
                    actionsCell.innerHTML = `
                        <div class="icon-btn" onclick="viewHistoryEntry('${entry.id}')" title="Ver">
                            <i class="fas fa-eye"></i>
                        </div>
                        <div class="icon-btn delete" onclick="deleteHistoryEntry('${entry.id}')" title="Excluir">
                            <i class="fas fa-trash"></i>
                        </div>
                    `;
                });
            }
            
            window.viewHistoryEntry = function(id) {
                const history = JSON.parse(localStorage.getItem('lootHistory') || '[]');
                const entry = history.find(e => e.id == id);
                if (entry) {
                    document.getElementById('sessionData').value = entry.sessionData;
                    players = entry.players;
                    currentCalcId = entry.id;
                    currentTag = entry.tag;
                    
                    // Atualizar tag selecionada
                    document.querySelectorAll('.tag').forEach(tag => {
                        tag.classList.toggle('active', tag.dataset.tag === currentTag);
                    });
                    
                    displayPlayersTable();
                    calculate();
                    loadHistory();
                }
            }
            
            window.deleteHistoryEntry = function(id) {
                if (!confirm('Remover este registro do histórico?')) return;
                let history = JSON.parse(localStorage.getItem('lootHistory') || '[]');
                history = history.filter(e => e.id != id);
                localStorage.setItem('lootHistory', JSON.stringify(history));
                loadHistory();
            }
            
            window.clearHistory = function() {
                if (!confirm('Limpar todo o histórico? Esta ação não pode ser desfeita.')) return;
                localStorage.removeItem('lootHistory');
                loadHistory();
            }
            
            function clearAll() {
                document.getElementById('sessionData').value = '';
                document.getElementById('playersTableContainer').style.display = 'none';
                document.getElementById('result').style.display = 'none';
                document.getElementById('empty-result').style.display = 'block';
                document.getElementById('loot-recalculate-btn').style.display = 'none';
                document.getElementById('unsaved-changes').style.display = 'none';
                players = [];
                currentCalcId = null;
                hasUnsavedChanges = false;
                loadHistory();
            }
            
function copyAllTransfers() {
    if (!lastCalculationResult.activePlayers || lastCalculationResult.activePlayers.length === 0) {
        alert("Nenhum cálculo válido para copiar.");
        return;
    }

    const { transfers } = lastCalculationResult;
    let fullText = '';

    // Formatar as transferências conforme solicitado
    transfers.forEach(t => {
        const amountWithoutDots = t.amount.toString().replace(/[.,]/g, '');
        fullText += `${t.from}\ntransfer ${amountWithoutDots} to ${t.to}\n\n`;
    });

    // Copia para o clipboard
    navigator.clipboard.writeText(fullText).then(() => {
        const btn = document.getElementById('copy-all-btn');
        const originalText = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copiado!';
        btn.style.backgroundColor = 'var(--success-color)';
        setTimeout(() => {
            btn.innerHTML = originalText;
            btn.style.backgroundColor = '';
        }, 2000);
    }).catch(err => {
        console.error('Erro ao copiar:', err);
        alert('Falha ao copiar para o clipboard.');
    });
}
            
            function updateRecalculateButton() {
                const recalculateBtn = document.getElementById('loot-recalculate-btn');
                const unsavedChanges = document.getElementById('unsaved-changes');
                
                if (hasUnsavedChanges && currentCalcId) {
                    recalculateBtn.style.display = 'inline-flex';
                    unsavedChanges.style.display = 'block';
                } else {
                    recalculateBtn.style.display = 'none';
                    unsavedChanges.style.display = 'none';
                }
            }

            document.getElementById('loot-calculate-btn').addEventListener('click', function() {
                parseData();
                calculate();
            });
            
            document.getElementById('loot-recalculate-btn').addEventListener('click', function() {
                calculate();
            });
            
            document.getElementById('loot-clear-btn').addEventListener('click', clearAll);
            document.getElementById('loot-add-player-btn').addEventListener('click', addManualPlayer);
            document.getElementById('copy-all-btn').addEventListener('click', copyAllTransfers);
            document.getElementById('clear-history-btn').addEventListener('click', clearHistory);

            // Sistema de tags
            document.querySelectorAll('.tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    document.querySelectorAll('.tag').forEach(t => t.classList.remove('active'));
                    this.classList.add('active');
                    currentTag = this.dataset.tag;
                    
                    // Se já tivermos um cálculo, marcar como não salvo
                    if (currentCalcId) {
                        hasUnsavedChanges = true;
                        updateRecalculateButton();
                    }
                });
            });

            const container = document.querySelector('.loot-container');
            container.addEventListener('input', function(e) {
                const target = e.target;
                if (target.matches('.profit-input, .waste-input')) {
                    const index = target.closest('tr').dataset.index;
                    const type = target.classList.contains('profit-input') ? 'profit' : 'waste';
                    if (players[index]) {
                        players[index][type] = cleanNumber(target.value);
                        target.value = formatNumber(players[index][type]);
                        hasUnsavedChanges = true;
                        updateRecalculateButton();
                    }
                }
                
                // Se o usuário digitar no textarea principal
                if (target.id === 'sessionData') {
                    hasUnsavedChanges = true;
                    updateRecalculateButton();
                }
            });

            container.addEventListener('change', function(e) {
                if (e.target.matches('.player-active-checkbox')) {
                    const index = e.target.closest('tr').dataset.index;
                    if (players[index]) {
                        players[index].active = e.target.checked;
                        hasUnsavedChanges = true;
                        updateRecalculateButton();
                    }
                }
            });

            container.addEventListener('click', function(e) {
                const transferDiv = e.target.closest('.transfer');
                if (transferDiv) {
                    navigator.clipboard.writeText(transferDiv.dataset.copytext);
                    transferDiv.classList.add('copied');
                    setTimeout(() => transferDiv.classList.remove('copied'), 1000);
                }
            });
            
            loadHistory();
            setTimeout(() => {
                parseData();
                calculate();
            }, 500);
        })();
    </script>
</body>
</html>