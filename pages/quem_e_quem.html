<style>
    .quem-container { max-width: 900px; margin: auto; }
    .quem-panel { background-color: var(--panel-bg-color); border: 1px solid var(--border-color); border-radius: 8px; padding: 25px; margin-bottom: 20px; }
    .input-group { display: flex; margin-bottom: 20px; }
    .input-group input { flex-grow: 1; padding: 12px; border-radius: 6px 0 0 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-color); font-size: 1rem; }
    .input-group button { padding: 12px 20px; border: none; background-color: var(--info-color); color: white; cursor: pointer; font-size: 1rem; font-weight: 600; border-radius: 0 6px 6px 0; }
    #admin-qeq-panel { display: none; }
    .admin-section { margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--border-color); }
    .admin-form { display: flex; gap: 10px; flex-wrap: wrap; align-items: flex-end; }
    .admin-form .form-group { flex: 1; min-width: 200px; }
    .admin-form label { font-weight: 600; font-size: 0.9em; display: block; margin-bottom: 5px; }
    .admin-form input, .admin-form select { width: 100%; padding: 8px; background-color: var(--bg-color); border: 1px solid var(--border-color); color: var(--text-color); border-radius: 4px; }
    .admin-form button { padding: 8px 15px; }
    .active-plus-list { max-height: 300px; overflow-y: auto; list-style: none; padding: 0; }
    .active-plus-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid var(--border-color); }
    .active-plus-item:last-child { border-bottom: none; }
    .plus-star { color: var(--gold-accent); cursor: help; margin-left: 5px; }
    .remove-plus-btn { background-color: var(--danger-color); color: white; border: none; padding: 4px 8px; font-size: 0.8em; border-radius: 4px; cursor: pointer; }
    .alert { padding: 15px; border-radius: 6px; margin-top: 15px; }
    .alert-danger { background-color: rgba(218, 54, 51, 0.2); color: var(--danger-color); }
    .list-group { list-style: none; padding: 0; }
    .list-group-item { background-color: var(--bg-color); border: 1px solid var(--border-color); padding: 10px 15px; margin-bottom: -1px; display: flex; justify-content: space-between; align-items: center; }
    .character-card { background-color: var(--bg-color); padding: 20px; border-radius: 8px; border: 1px solid var(--border-color); margin-top: 20px; }
    .character-card h5 { color: var(--gold-accent); margin-bottom: 15px; }
    .character-card p { margin-bottom: 8px; }
    .badge { background-color: var(--info-color); padding: 3px 8px; border-radius: 10px; font-size: 0.8em; }
    .mt-3 { margin-top: 15px; }
    .list-group-item { margin-bottom: 8px; border-radius: 4px; }
</style>

<div class="header-container">
    <h1><i class="fas fa-search"></i> Quem é Quem?</h1>
</div>

<div class="quem-container">
    <div class="quem-panel" id="qeq-search-tool">
        <div style="display:flex; justify-content: space-between; align-items: center;">
            <p style="color: var(--text-muted-color);">Digite o nome de um personagem para ver suas informações detalhadas.</p>
            <button id="qeq-manage-btn" class="action-btn" style="display: none; background-color: var(--gold-accent); color: #111; flex-shrink: 0; margin-left: 15px;">Gerenciar Plus</button>
        </div>
        <div class="input-group">
            <input type="text" id="character-name-input" placeholder="Nome do Personagem">
            <button id="search-button" type="button">Buscar</button>
        </div>
        <div id="results-container"></div>
        <div id="loading-spinner" style="display: none; text-align: center;"><div class="spinner-border"></div></div>
    </div>

    <div class="quem-panel" id="admin-qeq-panel" style="display: none;">
        <h3><i class="fas fa-crown" style="color:var(--gold-accent);"></i> Gerenciamento de Acesso "Plus"</h3>
        
        <div class="admin-section">
            <h4>Adicionar/Estender Acesso Plus</h4>
            <div class="admin-form">
                <div class="form-group">
                    <label for="plus-user-identifier">Email ou Nome do Personagem</label>
                    <input type="text" id="plus-user-identifier" placeholder="email@exemplo.com ou Player Name">
                </div>
                <div class="form-group">
                    <label for="plus-duration">Duração</label>
                    <select id="plus-duration">
                        <option value="30">1 Mês</option>
                        <option value="364">1 Ano</option>
                    </select>
                </div>
                <button id="plus-add-time-btn" style="background-color: var(--success-color);">Adicionar Tempo</button>
            </div>
        </div>

        <div class="admin-section">
            <h4>Usuários Plus Ativos</h4>
            <ul class="active-plus-list" id="plus-active-list">
                </ul>
        </div>
    </div>
</div>

<script>
(function() {
    if (!document.getElementById('qeq-search-tool')) return;

    const searchButton = document.getElementById('search-button');
    const nameInput = document.getElementById('character-name-input');
    const resultsContainer = document.getElementById('results-container');
    const loadingSpinner = document.getElementById('loading-spinner');
    
    const adminPanel = document.getElementById('admin-qeq-panel');
    const manageBtn = document.getElementById('qeq-manage-btn');
    const addTimeBtn = document.getElementById('plus-add-time-btn');
    const userIdentifierInput = document.getElementById('plus-user-identifier');
    const durationSelect = document.getElementById('plus-duration');
    const activePlusList = document.getElementById('plus-active-list');
    
    let allUsers = [];

    const performSearch = async () => {
        const characterName = nameInput.value.trim();
        if (!characterName) {
            resultsContainer.innerHTML = '<div class="alert alert-warning">Por favor, digite um nome.</div>';
            return;
        }
        loadingSpinner.style.display = 'block';
        resultsContainer.innerHTML = '';
        const encodedName = encodeURIComponent(characterName);
        const apiUrl = `/api/stalker/${encodedName}`;

        try {
            const response = await fetch(apiUrl);
            if (!response.ok) throw new Error(`Personagem não encontrado ou API indisponível`);
            const data = await response.json();
            
            let html = `
                <div class="character-card">
                    <h5>Resultados para: ${data.name}</h5>
                    <p><strong>Mundo:</strong> ${data.world}</p>
                    <p><strong>Vocação:</strong> ${data.vocation}</p>
                    <p><strong>Nível:</strong> ${data.level}</p>
                    <p><strong>Último Login:</strong> ${new Date(data.lastLogin).toLocaleString()}</p>
            `;
            
            if (data.otherVisibleCharacters && data.otherVisibleCharacters.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>Outros Personagens Visíveis:</h6>
                        <p>${data.otherVisibleCharacters.join(', ')}</p>
                    </div>
                `;
            }
            
            if (data.possibleInvisibleCharacters && data.possibleInvisibleCharacters.length > 0) {
                html += `
                    <div class="mt-3">
                        <h6>Possíveis Personagens na mesma conta, quanto maior os pontos maior a probabilidade:</h6>
                        <ul class="list-group">`;
                
                data.possibleInvisibleCharacters.forEach(char => {
                    html += `
                        <li class="list-group-item">
                            <div class="d-flex justify-content-between align-items-center">
                                <span>${char.otherCharacterName}</span>
                                <span class="badge">Pontos: ${char.numberOfMatches}</span>
                            </div>
                        </li>
                    `;
                });
                
                html += `</ul></div>`;
            }
            
            html += `</div>`;
            
            resultsContainer.innerHTML = html;
        } catch (error) {
            resultsContainer.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
        } finally {
            loadingSpinner.style.display = 'none';
        }
    };

    const renderActivePlusList = (users) => {
        if (!activePlusList) return;
        const activeUsers = users.filter(u => u.plusExpiresAt && new Date(u.plusExpiresAt) > new Date());
        activePlusList.innerHTML = '';
        if (activeUsers.length === 0) {
            activePlusList.innerHTML = '<li>Nenhum usuário com Plus ativo no momento.</li>';
            return;
        }
        activeUsers.sort((a,b) => new Date(a.plusExpiresAt) - new Date(b.plusExpiresAt));
        activeUsers.forEach(user => {
            const expirationDate = new Date(user.plusExpiresAt);
            const li = document.createElement('li');
            li.className = 'active-plus-item';
            li.innerHTML = `
                <div>
                    <strong>${user.characterName || 'N/A'}</strong> (${user.name})
                    <small style="display:block; color:var(--text-muted-color);">Expira em: ${expirationDate.toLocaleDateString('pt-BR')}</small>
                </div>
                <button class="remove-plus-btn" data-identifier="${user.email}">Remover</button>
            `;
            activePlusList.appendChild(li);
        });
    };

    const initializePage = () => {
        if (!window.appSocket) {
            console.error("Socket principal (window.appSocket) não foi encontrado.");
            return;
        }

        if (searchButton) searchButton.addEventListener('click', performSearch);
        if (nameInput) nameInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') performSearch();
        });

        window.appSocket.on('qeq:userListResponse', (users) => {
            allUsers = users;
            renderActivePlusList(allUsers);
        });

        const isAdmin = window.qeqIsAdmin === true;
        if (isAdmin && adminPanel && manageBtn) {
            manageBtn.style.display = 'inline-block';

            manageBtn.addEventListener('click', () => {
                const isHidden = adminPanel.style.display === 'none';
                adminPanel.style.display = isHidden ? 'block' : 'none';
                if (isHidden) {
                    window.appSocket.emit('qeq:getUsersForManagement');
                }
            });

            addTimeBtn.addEventListener('click', () => {
                const identifier = userIdentifierInput.value.trim();
                if (!identifier) return alert('Por favor, insira o email ou nome do personagem.');
                const durationInDays = parseInt(durationSelect.value, 10);
                if (confirm(`Confirmar ação para ${identifier}?`)) {
                    window.appSocket.emit('qeq:addPlusTime', { identifier, durationInDays });
                    userIdentifierInput.value = '';
                }
            });

            activePlusList.addEventListener('click', (e) => {
                if (e.target.classList.contains('remove-plus-btn')) {
                    const identifier = e.target.dataset.identifier;
                    if (confirm(`Remover acesso Plus de ${identifier}?`)) {
                        window.appSocket.emit('qeq:addPlusTime', { identifier, durationInDays: 0 });
                    }
                }
            });
        }
        
        if (window.qeqIsAdmin !== undefined) {
            delete window.qeqIsAdmin;
        }
    };

    initializePage();
})();
</script>