<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranking e Pontos</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>
<body>

<div id="ranking-page-container">
<style>
    .planilha-container { overflow: auto; position: relative; cursor: grab; user-select: none; border: 1px solid var(--border-color); border-radius: 8px; background-color: var(--bg-color); padding: 5px; }
    .planilha-container.active { cursor: grabbing; }
    .planilha-table { border-collapse: collapse; width: max-content; font-size: 0.85em; table-layout: fixed; }

    .planilha-table th, .planilha-table td {
        border: 1px solid var(--border-color);
        text-align: center;
        vertical-align: middle;
    }

    .planilha-table th {
        padding: 4px 6px;
        font-size: 0.8em;
        background-color: var(--panel-bg-color);
        color: var(--gold-accent);
        position: sticky;
        top: 0;
        z-index: 2;
    }

    .planilha-table td {
        height: 10px;
        padding: 0 3px;
        font-size: 0.8em;
    }

    .time-header {
        position: sticky;
        left: 0;
        z-index: 1;
        font-weight: bold;
        width: 60px;
        background-color: var(--panel-bg-color);
    }
    .planilha-table th.time-header {
        z-index: 3;
    }

    .planilha-table th:not(.time-header) { cursor: pointer; }
    .planilha-table th:not(.time-header):hover { background-color: #2b2105; }

    .planilha-table th:not(.time-header), .planilha-table td:not(.time-header) {
        width: 140px;
    }
    .planilha-table th:not(.time-header) {
        white-space: normal;
        word-wrap: break-word;
    }
    .planilha-table td:not(.time-header) {
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .slot.assigned { background-color: var(--info-color); color: white; font-weight: bold; cursor: help; }
    .slot.assigned[rowspan] {
        vertical-align: middle;
        font-size: 1.1em;
        white-space: normal;
    }
    .slot.is-absence { background-color: #F08080 !important; color: #111 !important; border-color: #CD5C5C !important; }
    .slot.is-double { background-color: #90EE90 !important; color: #111 !important; border-color: #3CB371 !important; }

    #leader-assignment-actions h4 { margin-top: 0; color: var(--gold-accent); }
    #leader-assignment-actions label { display: block; margin-bottom: 8px; cursor: pointer; }
    #leader-assignment-actions input[type="checkbox"] { margin-right: 8px; }

    .modal-content .member-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin-bottom: 5px; background-color: var(--bg-color); border-radius: 4px; }
    .status-dot { width: 12px; height: 12px; border-radius: 50%; display: inline-block; flex-shrink: 0; }
    .status-dot.online { background-color: var(--success-color); }
    .status-dot.offline { background-color: var(--danger-color); }
    .planilha-toggles { display: flex; gap: 10px; margin-bottom: 15px; }
    .toggle-btn { padding: 8px 15px; border-radius: 6px; border: 1px solid var(--border-color); background-color: var(--bg-color); color: var(--text-muted-color); font-weight: bold; cursor: pointer; }
    .toggle-btn.active { background-color: var(--gold-accent); color: #111; border-color: var(--gold-accent); }
    #assignment-modal select, #assignment-modal input[type="time"] { width: 100%; padding: 10px; margin-bottom: 15px; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 6px; font-size: 1em; }
    #manage-group-btn, #show-rules-btn, #manage-all-groups-btn { padding: 6px 15px; font-size: 0.9em; flex-grow: 0; white-space: nowrap; }
    .remove-member-btn { padding: 2px 8px !important; font-size: 0.9em !important; line-height: 1.2; flex-grow: 0 !important; flex-shrink: 0 !important; }
    .group-member-view { display: flex; align-items: center; gap: 10px; padding: 8px; border-bottom: 1px solid var(--border-color); }
    .group-member-view:last-child { border-bottom: none; }
    .member-details { display: flex; flex-direction: column; align-items: flex-start; }
    .member-name { font-weight: bold; font-size: 1.1em; }
    .member-info { font-size: 0.9em; color: var(--text-muted-color); }
    #rules-modal .modal-content { max-width: 800px; }
    #rules-modal h5 { color: var(--gold-accent); margin-top: 20px; margin-bottom: 5px; border-bottom: 1px solid var(--border-color); padding-bottom: 5px; }
    #rules-modal p, #rules-modal li { text-align: left; line-height: 1.6; }
    .planilha-container { max-height: 75vh; }
    .planilha-legenda {
        display: flex;
        gap: 20px;
        margin-top: 15px;
        padding-left: 5px;
        align-items: center;
        flex-wrap: wrap; 
    }
    .legenda-item {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.9em;
    }
    .legenda-cor {
        width: 15px;
        height: 15px;
        border-radius: 3px;
        border: 1px solid rgba(255, 255, 255, 0.2);
    }
    /* As cores correspondem às usadas na planilha */
    .legenda-cor.normal { background-color: var(--info-color); }
    .legenda-cor.falta { background-color: #F08080; }
    .legenda-cor.double { background-color: #90EE90; }
</style>

<div class="planilha-toggles">
    <button id="toggle-normal" class="toggle-btn active" data-type="normal">Planilha Normal</button>
    <button id="toggle-double" class="toggle-btn" data-type="double">Planilha Next</button>
    <div class="header-actions" style="display: flex; gap: 10px; margin-left: auto;">
        <div class="planilha-legenda">
            <div class="legenda-item">
                <span class="legenda-cor normal"></span>
                <span>Normal</span>
            </div>
            <div class="legenda-item">
                <span class="legenda-cor falta"></span>
                <span>Falta</span>
            </div>
            <div class="legenda-item">
                <span class="legenda-cor double"></span>
                <span>Double</span>
            </div>
        </div>
        <button id="show-rules-btn" class="action-btn">Regras</button>
        <button id="manage-group-btn" class="action-btn">Meu Grupo</button>
        <button id="manage-all-groups-btn" class="action-btn" style="display: none;">Gerenciar Grupos</button>
    </div>
</div>

<div id="planilha-container" class="planilha-container">
    <div id="planilha-loading" style="padding: 20px; text-align: center;">Carregando dados da planilha...</div>
    <table id="planilha-table" class="planilha-table" style="display: none;"></table>
</div>

<div id="rules-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h1>Regras da PT Planilhada</h1>

        <h5>1. Alterações na planilha</h5>
        <p>A planilha não será alterada mensalmente. Caso precise de alguma modificação, entre em contato com o SUPORTE para avaliação da disponibilidade.</p>

        <h5>2. Adiantamento da hunt</h5>
        <p>Caso precise adiantar sua hunt, é OBRIGATÓRIO avisar o grupo social e o SUPORTE. No entanto, a PT ainda poderá claimar igual horário (3:30) registrado na planilha.</p>

        <h5>3. Cancelamento de hunts</h5>
        <p>Se a hunt não ocorrer por qualquer motivo, avise o GRUPO SOCIAL e o SUPORTE. Se golpe/falta for recorrente, a liderança avaliará a situação e poderá aplicar penalidades à PT inteira.</p>

        <h5>4. Falta de um membro da PT planilhada</h5>
        <p>Caso um membro da PT não compareça, será permitido o pagamento de service ou a substituição por outro player da guild para completar a PT.</p>

        <h5>5. Obrigatoriedade de claimar no horário planilhado</h5>
        <p>É obrigatório claimar no seu horário planilhado. Se não claimar dentro de 15 minutos, prejudicando o NEXT, a PT perderá a HUNT para quem claimou e receberá penalidade (avaliada pela liderança). PORTANTO, NÃO DEIXE DE CLAIMAR SEU PLANILhado, PARA NÃO PERDER A RAZÃO.</p>

        <h5>6. Identificação e responsabilidades da PT</h5>
        <ul>
            <li>Toda o lider da PT receberá o grupo de PLANILhado.</li>
            <li>É responsabilidade da PT claimar no horário programado.</li>
            <li>Caso a PT faça duas hunts no mesmo local, o horário fora do planilhado (segundo horario), é obrigatório que qualquer membro use o comando !resp X 02:30 para claimar e respeitar o horário do seu rank.</li>
            <li>Se houver erros no claim (planilhado ou não), a PT inteira receberá um RESP BLOCK de 3 dias.</li>
            <li>Esta regra também se aplica a outras hunts planilhadas.</li>
        </ul>

        <h5>7. NEXT</h5>
        <p>Após o término do horário planilhado, se houver um NEXT, ele terá preferência total para caçar, independentemente de atrasos na pausa ou início da hunt anterior.</p>
        <p><strong>Tolerância máxima de atraso: 15 minutos.</strong></p>

    </div>
</div>


<div id="group-management-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h1>Gerenciar Meu Grupo</h1>
        <p>Seu nome como líder é fixo. Máximo de 4 membros.</p>
        <div id="current-members-list" style="margin-bottom: 15px;"></div>
        <form id="add-member-form" style="display: flex; gap: 10px; margin-bottom: 20px;">
            <input type="text" id="new-member-name" placeholder="Nome do novo membro" required style="flex-grow: 1;">
            <button type="submit" class="action-btn success-btn">Adicionar</button>
        </form>
        <button id="save-group-btn" class="action-btn" style="width: 100%;">Fechar e Salvar</button>
    </div>
</div>

<div id="view-group-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h1 id="view-group-title">Grupo Agendado</h1>
        <div id="view-group-body"></div>
        <div id="leader-assignment-actions" style="display: none; margin-top: 15px; border-top: 1px solid #555; padding-top: 15px;">
            <h4>Ações do Líder</h4>
            <div>
                <label>
                    <input type="checkbox" id="absence-checkbox"> Marcar como Falta
                </label>
            </div>
            <div>
                <label>
                    <input type="checkbox" id="double-checkbox"> Marcar como Double
                </label>
            </div>
            <div id="observation-edit-container-modal" style="margin-top: 10px; display: none;">
                <label for="assignment-observation-edit-modal" style="margin-bottom: 5px;">Observação:</label>
                <textarea id="assignment-observation-edit-modal" rows="2" style="width: 100%; padding: 8px; background-color: var(--bg-color); color: var(--text-color); border: 1px solid var(--border-color); border-radius: 4px; font-size: 0.95em;"></textarea>
            </div>
            <button id="save-status-btn" class="action-btn" style="width: 100%; margin-top: 10px;">Salvar Status</button>
        </div>
        <button id="remove-assignment-btn" class="action-btn danger-btn" style="width: 100%; margin-top: 20px; display: none;">Remover Agendamento</button>
    </div>
</div>

<div id="assignment-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h1 id="assignment-title">Agendar Respawn</h1>
        <form id="assignment-form">
            <label for="assignment-group">Selecione o Grupo:</label>
            <select id="assignment-group" required></select>
            <label for="assignment-start-time">Hora de Início:</label>
            <input type="time" id="assignment-start-time" step="1800" required>
            <label for="assignment-duration">Duração:</label>
            <select id="assignment-duration" required>
                <option value="2.5">2:30</option>
                <option value="3">3:00</option>
                <option value="3.5">3:30</option>
                <option value="4">4:00</option>
                <option value="4.5">4:30</option>
            </select>
            
            <div id="observation-input-container" style="display: none;">
                <label for="assignment-observation">Observação (Opcional):</label>
                <input type="text" id="assignment-observation" placeholder="Ex: Seg a Sex, Semanal...">
            </div>
            
            <button type="submit" class="action-btn success-btn" style="width: 100%; margin-top: 15px;">Confirmar Agendamento</button>
        </form>
    </div>
</div>

<div id="manage-all-groups-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="modal-close-btn">&times;</button>
        <h1>Gerenciar Todos os Grupos</h1>
        <p>Clique em "Deletar" para remover um grupo e todos os seus agendamentos.</p>
        <div id="all-groups-list" style="max-height: 400px; overflow-y: auto;"></div>
    </div>
</div>
</div>

<script>
(function() {
    function initializePlanilhadoPage(socket) {
        let currentView = 'normal';
        let planilhadoData = { normal: null, double: null };
        let localGroupMembers = [];

        const container = document.getElementById('planilha-container');
        const table = document.getElementById('planilha-table');
        const loadingDiv = document.getElementById('planilha-loading');
        
        const manageGroupBtn = document.getElementById('manage-group-btn');
        const groupModal = document.getElementById('group-management-modal');
        const viewGroupModal = document.getElementById('view-group-modal');
        const assignmentModal = document.getElementById('assignment-modal');
        const toggleNormalBtn = document.getElementById('toggle-normal');
        const toggleDoubleBtn = document.getElementById('toggle-double');
        
        const rulesModal = document.getElementById('rules-modal');
        const assignmentForm = document.getElementById('assignment-form');

        const manageAllGroupsBtn = document.getElementById('manage-all-groups-btn');
        const manageAllGroupsModal = document.getElementById('manage-all-groups-modal');
        if (window.isAdmin) {
            manageAllGroupsBtn.style.display = 'inline-block';
        }

        let isDown = false;
        let startX;
        let scrollLeft;
        if (container) {
            container.addEventListener('mousedown', (e) => {
                isDown = true;
                container.classList.add('active');
                startX = e.pageX - container.offsetLeft;
                scrollLeft = container.scrollLeft;
            });
            container.addEventListener('mouseleave', () => { isDown = false; container.classList.remove('active'); });
            container.addEventListener('mouseup', () => { isDown = false; container.classList.remove('active'); });
            container.addEventListener('mousemove', (e) => {
                if (!isDown) return;
                e.preventDefault();
                const x = e.pageX - container.offsetLeft;
                const walk = (x - startX) * 2;
                container.scrollLeft = scrollLeft - walk;
            });
        }
        
        function switchView(type) {
            currentView = type;
            toggleNormalBtn.classList.toggle('active', type === 'normal');
            toggleDoubleBtn.classList.toggle('active', type === 'double');
            if (!planilhadoData[type]) {
                loadingDiv.style.display = 'block';
                table.style.display = 'none';
                socket.emit('planilhado:getData', { type });
            } else {
                renderPlanilha();
            }
        }

        toggleNormalBtn.onclick = () => switchView('normal');
        toggleDoubleBtn.onclick = () => switchView('double');

        function renderPlanilha() {
            const data = planilhadoData[currentView];
            if (!data || !table || !loadingDiv) return;
            const { respawns, schedule } = data;
            if (!respawns || respawns.length === 0) {
                loadingDiv.innerHTML = `<p>Nenhum respawn foi configurado para a Planilha ${currentView === 'double' ? 'Double' : 'Normal'}.</p>`;
                loadingDiv.style.display = 'block';
                table.style.display = 'none';
                return;
            }
            loadingDiv.style.display = 'none';
            table.style.display = '';
            table.innerHTML = '';
            const headerRow = table.createTHead().insertRow(0);
            headerRow.innerHTML = '<th class="time-header">Hora</th>';
            respawns.forEach(respawn => {
                const th = document.createElement('th');
                th.innerText = respawn.name;
                th.dataset.code = respawn.code;
                th.dataset.name = respawn.name;
                headerRow.appendChild(th);
            });
            const tbody = table.createTBody();
            const timeSlots = Array.from({length: 48}, (_, i) => {
                const hour = Math.floor(i / 2);
                const minute = (i % 2) * 30;
                return `${String(hour).padStart(2, '0')}:${String(minute).padStart(2, '0')}`;
            });
            const orderedTimeSlots = [...timeSlots.slice(10), ...timeSlots.slice(0, 10)];
            const skipCounters = {};
            respawns.forEach(r => { skipCounters[r.code] = 0; });
            const calculateRowspan = (respawnCode, leader, startIndex) => {
                let count = 1;
                for (let i = startIndex + 1; i < orderedTimeSlots.length; i++) {
                    const nextSlotTime = orderedTimeSlots[i];
                    const nextAssignment = schedule[respawnCode]?.[nextSlotTime];
                    if (nextAssignment && nextAssignment.leader === leader) {
                        count++;
                    } else {
                        break;
                    }
                }
                return count;
            };
            orderedTimeSlots.forEach((timeSlot, timeIndex) => {
                const row = tbody.insertRow();
                row.innerHTML = `<td class="time-header">${timeSlot}</td>`;
                respawns.forEach(respawn => {
                    if (skipCounters[respawn.code] > 0) {
                        skipCounters[respawn.code]--;
                        return;
                    }
                    const slotCell = row.insertCell();
                    slotCell.dataset.code = respawn.code;
                    
                    const assignment = schedule[respawn.code]?.[timeSlot];

                    if (assignment && assignment.leader) {
                        const rowspan = calculateRowspan(respawn.code, assignment.leader, timeIndex);
                        
                        let slotClasses = 'slot assigned';
                        if (assignment.isAbsence) slotClasses += ' is-absence';
                        if (assignment.isDouble) slotClasses += ' is-double';
                        slotCell.className = slotClasses;
                        
                        let cellContent = `<span>${assignment.leader}</span>`;
                        if (assignment.observation) {
                            cellContent += `<br><small style="font-weight: normal; color: #ccc;">${assignment.observation}</small>`;
                        }
                        slotCell.innerHTML = cellContent;
                        
                        slotCell.dataset.leader = assignment.leader;
                        if (rowspan > 1) {
                            slotCell.rowSpan = rowspan;
                            skipCounters[respawn.code] = rowspan - 1;
                        }
                    } else {
                        slotCell.className = 'slot';
                    }
                });
            });
        }
        
        function renderGroupEditor() {
            const listDiv = document.getElementById('current-members-list');
            listDiv.innerHTML = '<h6>Membros Atuais:</h6>';
            localGroupMembers.forEach(member => {
                const item = document.createElement('div');
                item.className = 'member-item';
                item.innerHTML = `<span>${member}</span><button type="button" class="action-btn danger-btn remove-member-btn" data-name="${member}">X</button>`;
                listDiv.appendChild(item);
            });
            listDiv.querySelectorAll('.remove-member-btn').forEach(btn => {
                btn.onclick = (e) => {
                    const nameToRemove = e.target.dataset.name;
                    localGroupMembers = localGroupMembers.filter(m => m !== nameToRemove);
                    renderGroupEditor();
                };
            });
        }
        
        manageGroupBtn.onclick = () => {
            const myLeaderName = window.activeCharacterName;
            if (!myLeaderName) return alert("Você precisa estar logado.");
            const currentData = planilhadoData.normal || planilhadoData.double;
            if (!currentData) return alert("Aguarde os dados da planilha carregarem.");
            const myGroup = currentData.groups.find(g => g.leader === myLeaderName);
            if (myGroup && myGroup.members) {
                localGroupMembers = myGroup.members.map(m => m.name).filter(name => name !== myLeaderName);
            } else {
                localGroupMembers = [];
            }
            renderGroupEditor();
            groupModal.classList.add('show');
        };
        document.getElementById('add-member-form').onsubmit = e => {
            e.preventDefault();
            if (localGroupMembers.length >= 4) return alert("Limite de 4 membros atingido.");
            const input = document.getElementById('new-member-name');
            const newName = input.value.trim();
            if (newName && !localGroupMembers.includes(newName) && newName !== window.activeCharacterName) {
                localGroupMembers.push(newName);
                renderGroupEditor();
                input.value = '';
            }
        };
        document.getElementById('save-group-btn').onclick = () => {
            socket.emit('planilhado:createOrUpdateGroup', localGroupMembers);
            groupModal.classList.remove('show');
        };
        assignmentForm.onsubmit = (ev) => {
            ev.preventDefault();
            const respawnCode = assignmentForm.dataset.respawnCode;
            if (!respawnCode) return;
            const payload = {
                type: currentView,
                respawnCode: respawnCode,
                groupLeader: document.getElementById('assignment-group').value,
                startTime: document.getElementById('assignment-start-time').value,
                duration: parseFloat(document.getElementById('assignment-duration').value),
                observation: document.getElementById('assignment-observation').value.trim()
            };
            socket.emit('planilhado:assignGroup', payload);
            assignmentForm.reset();
            assignmentModal.classList.remove('show');
        };
        table.onclick = (e) => {
            const target = e.target.closest('.slot'); 
            if (target && target.classList.contains('assigned')) {
                const leader = target.dataset.leader;
                const respawnCode = target.dataset.code;
                const data = planilhadoData[currentView];
                if (!data) return;

                const groupData = data.groups.find(g => g.leader === leader);
                const respawn = data.respawns.find(r => r.code === respawnCode);
                const respawnName = respawn ? respawn.name : respawnCode;
                
                let assignmentData = null;
                if (data.schedule[respawnCode]) {
                    for (const time in data.schedule[respawnCode]) {
                        const slot = data.schedule[respawnCode][time];
                        if (slot && slot.leader === leader) {
                            assignmentData = slot;
                            break;
                        }
                    }
                }

                viewGroupModal.querySelector('#view-group-title').innerText = `Grupo de ${leader}`;
                const body = viewGroupModal.querySelector('#view-group-body');
                body.innerHTML = ''; 
                if (groupData && groupData.members) {
                    const listContainer = document.createElement('div');
                    groupData.members.forEach(member => {
                        const memberDiv = document.createElement('div');
                        memberDiv.className = 'group-member-view';
                        memberDiv.innerHTML = `
                            <span class="status-dot ${member.online ? 'online' : 'offline'}"></span>
                            <div class="member-details">
                                <span class="member-name">${member.name}</span>
                                <span class="member-info">Lvl: ${member.level}, ${member.vocation} (${member.guildRank})</span>
                            </div>
                        `;
                        listContainer.appendChild(memberDiv);
                    });
                    body.appendChild(listContainer);
                } else {
                    body.innerHTML = '<p>Detalhes dos membros não encontrados.</p>';
                }

                const leaderActionsDiv = viewGroupModal.querySelector('#leader-assignment-actions');
                const removeBtn = viewGroupModal.querySelector('#remove-assignment-btn');
                
                if (window.isAdmin) {
                    leaderActionsDiv.style.display = 'block';
                    removeBtn.style.display = 'block';
                    
                    const absenceCheckbox = document.getElementById('absence-checkbox');
                    const doubleCheckbox = document.getElementById('double-checkbox');
                    const saveBtn = document.getElementById('save-status-btn');
                    
                    const observationContainer = document.getElementById('observation-edit-container-modal');
                    const observationTextarea = document.getElementById('assignment-observation-edit-modal');
                    
                    if (currentView === 'normal') {
                        observationContainer.style.display = 'block';
                        observationTextarea.value = assignmentData?.observation || '';
                    } else {
                        observationContainer.style.display = 'none';
                        observationTextarea.value = '';
                    }

                    absenceCheckbox.checked = assignmentData?.isAbsence || false;
                    doubleCheckbox.checked = assignmentData?.isDouble || false;

                    const newSaveBtn = saveBtn.cloneNode(true);
                    saveBtn.parentNode.replaceChild(newSaveBtn, saveBtn);
                    document.getElementById('save-status-btn').addEventListener('click', () => {
                        const payload = {
                            type: currentView,
                            respawnCode: respawnCode,
                            groupLeader: leader,
                            isAbsence: absenceCheckbox.checked,
                            isDouble: doubleCheckbox.checked,
                            observation: observationTextarea.value.trim() 
                        };
                        socket.emit('planilhado:updateAssignmentStatus', payload);
                        viewGroupModal.classList.remove('show');
                    });
                    const newRemoveBtn = removeBtn.cloneNode(true);
                    removeBtn.parentNode.replaceChild(newRemoveBtn, removeBtn);
                    document.getElementById('remove-assignment-btn').innerText = `Remover Agendamento de ${respawnName}`;
                    document.getElementById('remove-assignment-btn').onclick = () => {
                        if (confirm(`Remover o agendamento de ${leader} em ${respawnName}?`)) {
                            socket.emit('planilhado:removeAssignment', { type: currentView, respawnCode, groupLeader: leader });
                            viewGroupModal.classList.remove('show');
                        }
                    };
                } else {
                    leaderActionsDiv.style.display = 'none';
                    removeBtn.style.display = 'none';
                }
                
                viewGroupModal.classList.add('show');
            }
            else if (window.isAdmin && e.target.tagName === 'TH' && e.target.dataset.code) {
                const respawnCode = e.target.dataset.code;
                const respawnName = e.target.dataset.name;
                const data = planilhadoData[currentView];
                if (!data) return;
                
                assignmentForm.dataset.respawnCode = respawnCode;
                document.getElementById('assignment-title').innerText = `Agendar em ${respawnName}`;
                const groupSelect = document.getElementById('assignment-group');
                groupSelect.innerHTML = '';
                
                const sortedGroups = [...data.groups].sort((a, b) => a.leader.localeCompare(b.leader));
                sortedGroups.forEach(g => {
                    groupSelect.innerHTML += `<option value="${g.leader}">${g.leader}</option>`;
                });
                const observationContainer = document.getElementById('observation-input-container');
                if (currentView === 'normal') {
                    observationContainer.style.display = 'block';
                } else {
                    observationContainer.style.display = 'none';
                }
                
                assignmentModal.classList.add('show');
            }
        };

        manageAllGroupsBtn.onclick = () => {
            const data = planilhadoData.normal || planilhadoData.double;
            if (!data) return alert('Dados da planilha ainda não carregados.');
            
            const listDiv = document.getElementById('all-groups-list');
            listDiv.innerHTML = '';
            const sortedGroups = [...data.groups].sort((a, b) => a.leader.localeCompare(b.leader));

            if (sortedGroups.length === 0) {
                listDiv.innerHTML = '<p>Nenhum grupo encontrado.</p>';
            } else {
                sortedGroups.forEach(group => {
                    const item = document.createElement('div');
                    item.className = 'member-item';
                    item.innerHTML = `<span>${group.leader}</span><button class="action-btn danger-btn delete-group-btn" data-leader="${group.leader}">Deletar</button>`;
                    listDiv.appendChild(item);
                });
            }

            manageAllGroupsModal.classList.add('show');
        };
        document.getElementById('all-groups-list').addEventListener('click', (e) => {
            if (e.target.classList.contains('delete-group-btn')) {
                const leaderToDelete = e.target.dataset.leader;
                if (confirm(`Tem certeza que deseja DELETAR o grupo de "${leaderToDelete}"?\n\nATENÇÃO: Todas as reservas deste grupo em AMBAS as planilhas (Normal e Double) serão removidas permanentemente.`)) {
                    socket.emit('planilhado:deleteGroup', { groupLeader: leaderToDelete });
                    manageAllGroupsModal.classList.remove('show');
                }
            }
        });
        const cleanupAndCloseAssignmentModal = () => {
            if (assignmentForm.dataset.respawnCode) delete assignmentForm.dataset.respawnCode;
            assignmentModal.classList.remove('show');
        };
        
        assignmentModal.querySelector('.modal-close-btn').onclick = cleanupAndCloseAssignmentModal;
        assignmentModal.onclick = e => { if (e.target === assignmentModal) cleanupAndCloseAssignmentModal(); };
        document.getElementById('show-rules-btn').onclick = () => rulesModal.classList.add('show');
        rulesModal.querySelector('.modal-close-btn').onclick = () => rulesModal.classList.remove('show');
        rulesModal.onclick = e => { if (e.target === rulesModal) rulesModal.classList.remove('show'); };

        groupModal.querySelector('.modal-close-btn').onclick = () => groupModal.classList.remove('show');
        groupModal.onclick = e => { if (e.target === groupModal) groupModal.classList.remove('show'); };
        viewGroupModal.querySelector('.modal-close-btn').onclick = () => viewGroupModal.classList.remove('show');
        viewGroupModal.onclick = e => { if (e.target === viewGroupModal) viewGroupModal.classList.remove('show'); };
        manageAllGroupsModal.querySelector('.modal-close-btn').onclick = () => manageAllGroupsModal.classList.remove('show');
        manageAllGroupsModal.onclick = e => { if (e.target === manageAllGroupsModal) manageAllGroupsModal.classList.remove('show'); };
        socket.on('planilhado:dataUpdated', ({ type, data }) => {
            planilhadoData[type] = data;
            if (type === currentView) {
                renderPlanilha();
            }
        });
        switchView('normal');
    }

    if (window.appSocket) {
        initializePlanilhadoPage(window.appSocket);
    } else {
        document.addEventListener('socketReady', () => initializePlanilhadoPage(window.appSocket), { once: true });
    }
})();
</script>
</body>
</html>